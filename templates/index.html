<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HomeMatch - Personalized Real Estate Agent</title>
    <link rel="stylesheet" href="{{ url_for('static', path='/style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>üè† HomeMatch</h1>
            <p class="subtitle">Your Personalized Real Estate Agent</p>
        </header>

        <main>
            <section class="preferences-section">
                <h2>Tell us about your dream home</h2>
                <form id="preferencesForm" method="post" action="/api/search">
                    <div class="form-group">
                        <label for="preferences">Describe your ideal home and preferences:</label>
                        <textarea 
                            id="preferences" 
                            name="preferences" 
                            rows="6" 
                            placeholder="Example: I want a 3-bedroom house in a quiet neighborhood with good schools, a backyard for gardening, and easy access to public transportation. Budget around $800,000."
                            required
                        ></textarea>
                    </div>
                    
                    <button type="submit" class="search-btn">
                        üîç Find My Perfect Home
                    </button>
                </form>
            </section>

            <section class="results-section" id="resultsSection" style="display: none;">
                <h2>Personalized Recommendations</h2>
                <div id="results">
                    <!-- Results will be populated here -->
                </div>
                
                <div class="actions">
                    <button onclick="generateNewListings()" class="action-btn">
                        üîÑ Generate New Listings
                    </button>
                    <button onclick="showAllListings()" class="action-btn">
                        üìã View All Listings
                    </button>
                </div>
            </section>

            <section class="info-section">
                <h3>How HomeMatch Works</h3>
                <div class="info-grid">
                    <div class="info-card">
                        <h4>ü§ñ AI-Powered Understanding</h4>
                        <p>Our advanced language model understands your preferences in natural language.</p>
                    </div>
                    <div class="info-card">
                        <h4>üîç Semantic Search</h4>
                        <p>We use vector databases to find properties that match your unique needs.</p>
                    </div>
                    <div class="info-card">
                        <h4>‚ú® Personalized Descriptions</h4>
                        <p>Each listing is rewritten to highlight what matters most to you.</p>
                    </div>
                </div>
            </section>
        </main>

        <footer>
            <p>&copy; 2025 HomeMatch - Built with FastAPI & ChromaDB</p>
        </footer>
    </div>

    <script>
        // Form handling and API interactions
        document.getElementById('preferencesForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const preferences = formData.get('preferences');
            
            if (!preferences.trim()) {
                alert('Please describe your preferences');
                return;
            }
            
            // Show loading state
            showLoading();
            
            try {
                const response = await fetch('/api/search', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.detail || 'Search failed');
                }
                
                // Display results
                displayResults(result, preferences);
                
            } catch (error) {
                console.error('Error:', error);
                showError('An error occurred while searching. Please try again.');
            }
        });
        
        function showLoading() {
            const resultsSection = document.getElementById('resultsSection');
            const resultsDiv = document.getElementById('results');
            
            resultsSection.style.display = 'block';
            resultsDiv.innerHTML = `
                <div class="loading-container">
                    <div class="loading"></div>
                    <p>Searching for your perfect home...</p>
                </div>
            `;
            
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }
        
        function displayResults(data, preferences) {
            const resultsDiv = document.getElementById('results');
            
            if (data.results && data.results.length > 0) {
                let html = `
                    <div class="search-summary">
                        <h4>üéØ Found ${data.count} matches for: "${preferences}"</h4>
                        <p>${data.message}</p>
                    </div>
                    <div class="listings-grid">
                `;
                
                data.results.forEach(listing => {
                    const relevanceScore = listing.relevance_score ? 
                        `<span class="relevance">Relevance: ${(listing.relevance_score * 100).toFixed(0)}%</span>` : '';
                    
                    html += `
                        <div class="listing-card">
                            <div class="listing-header">
                                <h5>${listing.neighborhood || 'Unknown Area'}</h5>
                                ${relevanceScore}
                            </div>
                            <div class="listing-details">
                                <p class="price">üí∞ ${listing.price || 'Price TBD'}</p>
                                <p class="specs">üõèÔ∏è ${listing.bedrooms || 0} bed ‚Ä¢ üõÅ ${listing.bathrooms || 0} bath ‚Ä¢ üìè ${listing.house_size || 'Size TBD'}</p>
                                <p class="description">${listing.description || 'No description available'}</p>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                resultsDiv.innerHTML = html;
            } else {
                resultsDiv.innerHTML = `
                    <div class="no-results">
                        <h4>No listings found</h4>
                        <p>We couldn't find any listings matching your preferences: "${preferences}"</p>
                        <p>Try adjusting your search criteria or generate new listings.</p>
                    </div>
                `;
            }
        }
        
        function showError(message) {
            const resultsSection = document.getElementById('resultsSection');
            const resultsDiv = document.getElementById('results');
            
            resultsSection.style.display = 'block';
            resultsDiv.innerHTML = `
                <div class="error-message">
                    <h4>‚ùå Error</h4>
                    <p>${message}</p>
                </div>
            `;
            
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }
        
        async function generateNewListings() {
            try {
                showLoading();
                const response = await fetch('/api/generate-listings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ count: 12 })
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.detail || 'Generation failed');
                }
                
                document.getElementById('results').innerHTML = `
                    <div class="success-message">
                        <h4>‚úÖ ${result.message}</h4>
                        <p>Generated ${result.count} new listings and added them to the database.</p>
                        <p>You can now search for your preferences!</p>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error:', error);
                showError('Failed to generate new listings. Please try again.');
            }
        }
        
        async function showAllListings() {
            try {
                showLoading();
                const response = await fetch('/api/listings');
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.detail || 'Failed to load listings');
                }
                
                displayResults({
                    message: `Showing all ${result.count} available listings`,
                    count: result.count,
                    results: result.listings
                }, 'all listings');
                
            } catch (error) {
                console.error('Error:', error);
                showError('Failed to load all listings. Please try again.');
            }
        }
    </script>
</body>
</html>
